<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ARO - Manage Grades</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { color: #333; }
        h2 { color: #555; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        form { background: #fdfdfd; border: 1px solid #ccc; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        div { margin-bottom: 10px; }
        label { display: inline-block; width: 100px; }
        input[type="text"], select { padding: 5px; width: 250px; }
        button { padding: 5px 10px; background-color: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; }
        button:hover { background-color: #0056b3; }
        button.edit-btn { background-color: #ffc107; }
        button.edit-btn:hover { background-color: #e0a800; }
        button.delete-btn { background-color: #dc3545; }
        button.delete-btn:hover { background-color: #c82333; }
        button.clear-btn { background-color: #6c757d; }
        button.clear-btn:hover { background-color: #5a6268; }
        #logoutButton { background-color: #d9534f; float: right; }
        #logoutButton:hover { background-color: #c9302c; }
    </style>
</head>
<body>

    <button id="logoutButton">Logout</button>
    <h1>ARO Grade Management</h1>

    <h2>Add / Edit Grade</h2>
    <form id="gradeForm">
        <input type="hidden" id="gradeId" name="gradeId">

        <div>
            <label for="studentId">Student:</label>
            <select id="studentId" name="studentId" required>
                <option value="">Loading students...</option>
            </select>
        </div>
        <div>
            <label for="courseId">Course:</label>
            <select id="courseId" name="courseId" required>
                <option value="">Loading courses...</option>
            </select>
        </div>
        <div>
            <label for="term">Term:</label>
            <input type="text" id="term" name="term" placeholder="e.g., 202526S1" required>
        </div>
        <div>
            <label for="grade">Grade:</label>
            <select id="grade" name="grade" required>
                <option value="">Select Grade</option>
                <option value="A">A</option>
                <option value="A-">A-</option>
                <option value="B+">B+</option>
                <option value="B">B</option>
                <option value="B-">B-</option>
                <option value="C+">C+</option>
                <option value="C">C</option>
                <option value="C-">C-</option>
                <option value="D+">D+</option>
                <option value="D">D</option>
                <option value="F">F</option>
            </select>
        </div>
        <div>
            <label for="comments">Comments:</label>
            <input type="text" id="comments" name="comments">
        </div>
        <button type="submit">Save Grade</button>
        <button type="button" class="clear-btn" id="clearBtn">Clear Form</button>
    </form>

    <h2>Grades List</h2>
    <div>
        <label for="filterStudent">Filter by Student:</label>
        <select id="filterStudent">
            <option value="">All Students</option>
        </select>
        <button id="filterBtn">Filter</button>
        <button id="showAllBtn">Show All</button>
    </div>

    <table id="gradesTable">
        <thead>
            <tr>
                <th>Student</th>
                <th>Course</th>
                <th>Term</th>
                <th>Grade</th>
                <th>Comments</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="gradesTbody">
            </tbody>
    </table>

    <script>
        // DOM 載入完成後執行
        document.addEventListener('DOMContentLoaded', () => {

            // 從 localStorage 獲取 JWT
            const token = localStorage.getItem('access_token');
            const userName = localStorage.getItem('name');

            // 檢查 token，如果不存在則跳轉回登入頁面
            if (!token) {
                alert('You are not logged in. Redirecting to login page.');
                window.location.href = '/';
                return;
            }

            // 獲取 DOM 元素
            const gradeForm = document.getElementById('gradeForm');
            const gradeIdInput = document.getElementById('gradeId');
            const studentSelect = document.getElementById('studentId');
            const courseSelect = document.getElementById('courseId');
            const termInput = document.getElementById('term');
            const gradeSelect = document.getElementById('grade');
            const commentsInput = document.getElementById('comments');

            const filterStudentSelect = document.getElementById('filterStudent');
            const filterBtn = document.getElementById('filterBtn');
            const showAllBtn = document.getElementById('showAllBtn');
            const clearBtn = document.getElementById('clearBtn');
            const logoutButton = document.getElementById('logoutButton');

            const gradesTbody = document.getElementById('gradesTbody');

            // --- API 呼叫的通用函式 ---
            // 封裝 fetch，自動加入 Token
            async function apiFetch(url, options = {}) {
                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                };

                const config = {
                    ...options,
                    headers: { ...headers, ...options.headers },
                };

                try {
                    const response = await fetch(url, config);

                    if (response.status === 401) {
                        // Token 過期或無效
                        alert('Session expired. Please log in again.');
                        logout();
                        return;
                    }

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'API request failed');
                    }

                    // DELETE 請求可能沒有 JSON 回應
                    if (response.status === 204 || options.method === 'DELETE') {
                        return { success: true };
                    }

                    return response.json();

                } catch (error) {
                    console.error('Fetch error:', error);
                    alert(`Error: ${error.message}`);
                    throw error;
                }
            }

            // --- 載入初始數據 (學生/課程) ---

            // 載入學生列表到下拉選單
            async function loadStudents() {
                try {
                    const students = await apiFetch('/list_student'); // 呼叫 API
                    studentSelect.innerHTML = '<option value="">Select Student</option>';
                    filterStudentSelect.innerHTML = '<option value="">All Students</option>';

                    // 假設回傳的是 [ [id, first_name, last_name], ... ]
                    students.forEach(student => {
                        const option = document.createElement('option');
                        option.value = student[0]; // id
                        option.textContent = `${student[1]} ${student[2]}`; // first_name last_name

                        studentSelect.appendChild(option.cloneNode(true));
                        filterStudentSelect.appendChild(option);
                    });
                } catch (error) {
                    studentSelect.innerHTML = '<option value="">Failed to load students</option>';
                    console.error('Failed to load students', error);
                }
            }

            // 載入課程列表到下拉選單
            async function loadCourses() {
                try {
                    const courses = await apiFetch('/list_course'); // 呼叫 API
                    courseSelect.innerHTML = '<option value="">Select Course</option>';

                    // 假設回傳的是 [ [id, course_name], ... ]
                    courses.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course[0]; // id
                        option.textContent = course[1]; // course_name
                        courseSelect.appendChild(option);
                    });
                } catch (error) {
                    courseSelect.innerHTML = '<option value="">Failed to load courses</option>';
                    console.error('Failed to load courses', error);
                }
            }

            // --- 載入成績數據 ---

            // 載入成績列表 (可選 student_id 過濾)
            async function loadGrades(studentId = null) {
                let url = '/list_grades';
                if (studentId) {
                    // 根據 server.py，使用 URL 參數
                    url = `/list_grades?student_id=${studentId}`;
                }

                try {
                    const grades = await apiFetch(url);
                    renderGradesTable(grades);
                } catch (error) {
                    gradesTbody.innerHTML = '<tr><td colspan="6">Failed to load grades.</td></tr>';
                    console.error('Failed to load grades', error);
                }
            }

            // 渲染成績表格
            function renderGradesTable(grades) {
                gradesTbody.innerHTML = ''; // 清空表格
                if (!grades || grades.length === 0) {
                    gradesTbody.innerHTML = '<tr><td colspan="6">No grades found.</td></tr>';
                    return;
                }

                // 根據 sql_method_ARO_DRO.py 中的 list_all_grades_sql()
                // 回傳的順序是：g.id, g.student_id, s.first_name, s.last_name, c.course_name, g.term, g.grade, g.comments
                grades.forEach(grade => {
                    const tr = document.createElement('tr');

                    const gradeId = grade[0];
                    const studentId = grade[1];
                    const studentName = `${grade[2]} ${grade[3]}`;
                    const courseName = grade[4];
                    const term = grade[5];
                    const gradeValue = grade[6];
                    const comments = grade[7];

                    tr.innerHTML = `
                        <td>${studentName}</td>
                        <td>${courseName}</td>
                        <td>${term}</td>
                        <td>${gradeValue}</td>
                        <td>${comments}</td>
                        <td>
                            <button class="edit-btn"
                                    data-id="${gradeId}"
                                    data-student-id="${studentId}"
                                    data-course-id="${grade[4]}"
                                    data-term="${term}"
                                    data-grade="${gradeValue}"
                                    data-comments="${comments}">Edit</button>
                            <button class="delete-btn" data-id="${gradeId}">Delete</button>
                        </td>
                    `;
                    // 注意: data-course-id 這裡我們用 courseName 比較難反查 ID，
                    // 編輯時需要特別處理。
                    // 更好的做法是讓 /list_grades API 回傳 course_id
                    // 假設 `list_grades_by_student_id` 和 `list_all_grades_sql` 回傳的 course_id 在 grade[4] (course_name) 的位置
                    // 為了簡單起見，我們假設 `list_all_grades_sql` 查詢修改為回傳 course_id
                    // SELECT g.id, g.student_id, s.first_name, s.last_name, g.course_id, c.course_name, g.term, g.grade, g.comments
                    // 如果沒改，我們在編輯時就不能預選 course。
                    // *** 假設您的 API 回傳的 grade[4] (c.course_name) ***
                    // *** 編輯時我們無法輕易反向設定 course_id。
                    // *** 這裡我們假設 `list_all_grades_sql` 查詢 SELECT ... c.course_name ...

                    // 為了讓 "Edit" 正常運作，我們需要 course_id 和 student_id
                    // 您的 `list_all_grades_sql` 並未 SELECT g.course_id
                    // 最好修改 `sql_method_ARO_DRO.py` 中的 `list_all_grades_sql` 和 `list_grades_by_student_id`
                    // 增加 `g.course_id` 到 SELECT 列表中。
                    // 假設修改後: g.id[0], g.student_id[1], s.first_name[2], s.last_name[3], g.course_id[4], c.course_name[5], g.term[6], g.grade[7], g.comments[8]

                    // *** 暫時使用您目前的 SQL 輸出 (grade[4] = c.course_name) ***
                    // 我們將無法在 "Edit" 時預選 Student 和 Course





                    // g.id[0], g.student_id[1], s.first_name[2], s.last_name[3], c.course_name[4], g.term[5], g.grade[6], g.comments[7]

                    const editBtn = tr.querySelector('.edit-btn');
                    editBtn.dataset.studentId = studentId; // [1]
                    // editBtn.dataset.courseId = grade[??]; // 我們沒有 course_id
                    editBtn.dataset.term = term; // [5]
                    editBtn.dataset.grade = gradeValue; // [6]
                    editBtn.dataset.comments = comments; // [7]

                    gradesTbody.appendChild(tr);
                });
            }

            // --- 事件監聽 (Event Listeners) ---

            // 登出
            logoutButton.addEventListener('click', logout);

            function logout() {
                localStorage.removeItem('access_token');
                localStorage.removeItem('role');
                localStorage.removeItem('user_id');
                localStorage.removeItem('name');
                window.location.href = '/';
            }

            // 清空表單
            clearBtn.addEventListener('click', resetForm);

            // 過濾
            filterBtn.addEventListener('click', () => {
                const selectedStudentId = filterStudentSelect.value;
                loadGrades(selectedStudentId);
            });

            // 顯示全部
            showAllBtn.addEventListener('click', () => {
                filterStudentSelect.value = '';
                loadGrades();
            });

            // 提交表單 (新增或更新)
            gradeForm.addEventListener('submit', async (e) => {
                e.preventDefault(); // 阻止表單預設提交

                const id = gradeIdInput.value;
                const data = {
                    student_id: studentSelect.value,
                    course_id: courseSelect.value,
                    term: termInput.value,
                    grade: gradeSelect.value,
                    comments: commentsInput.value
                };

                try {
                    if (id) {
                        // 更新 (PUT)
                        // 根據 server.py，/modify_grades 需要 grade_id, grade, comments
                        const updateData = {
                            grade_id: id,
                            grade: data.grade,
                            comments: data.comments
                        };
                        await apiFetch('/modify_grades', {
                            method: 'PUT',
                            body: JSON.stringify(updateData)
                        });
                        alert('Grade updated successfully!');
                    } else {
                        // 新增 (POST)
                        // 根據 server.py，/add_grades 需要 student_id, course_id, term, grade, comments
                        await apiFetch('/add_grades', {
                            method: 'POST',
                            body: JSON.stringify(data)
                        });
                        alert('Grade added successfully!');
                    }

                    resetForm();
                    loadGrades(filterStudentSelect.value); // 重新載入表格

                } catch (error) {
                    alert('Failed to save grade. ' + error.message);
                }
            });

            // 表格點擊 (處理編輯和刪除)
            gradesTbody.addEventListener('click', async (e) => {
                const target = e.target;
                const id = target.dataset.id;

                if (target.classList.contains('edit-btn')) {
                    // 編輯按鈕
                    // 從 data-* 屬性中獲取數據
                    const { studentId, term, grade, comments } = target.dataset;

                    // 填入表單
                    gradeIdInput.value = id;
                    studentSelect.value = studentId;
                    // courseSelect.value = courseId; // 如前所述，我們缺少 course_id
                    termInput.value = term;
                    gradeSelect.value = grade;
                    commentsInput.value = comments;

                    // (如果缺少 course_id，我們至少要禁用 course select 或提醒用戶)
                    // 暫時禁用 Student 和 Course，因為我們只允許修改 Grade 和 Comments
                    studentSelect.disabled = true;
                    courseSelect.disabled = true;
                    termInput.disabled = true;

                    alert('Editing Grade. Student, Course, and Term are locked. Only Grade and Comments can be modified.');
                    window.scrollTo(0, 0); // 滾動到頁面頂部
                }

                if (target.classList.contains('delete-btn')) {
                    // 刪除按鈕
                    if (confirm(`Are you sure you want to delete grade record ${id}?`)) {
                        try {
                            // 根據 server.py，使用 URL 參數
                            await apiFetch(`/delete_grades?grades_id=${id}`, {
                                method: 'DELETE'
                            });
                            alert('Grade deleted successfully!');
                            loadGrades(filterStudentSelect.value); // 重新載入表格
                        } catch (error) {
                            alert('Failed to delete grade. ' + error.message);
                        }
                    }
                }
            });

            // 重設表單
            function resetForm() {
                gradeForm.reset();
                gradeIdInput.value = '';
                // 重新啟用下拉選單
                studentSelect.disabled = false;
                courseSelect.disabled = false;
                termInput.disabled = false;
            }

            // --- 初始化頁面 ---
            function initializePage() {
                if (userName) {
                    const welcome = document.createElement('h2');
                    welcome.textContent = `Welcome, ${userName} (ARO)`;
                    document.body.prepend(welcome);
                }
                loadStudents();
                loadCourses();
                loadGrades(); // 初始載入所有成績
            }

            initializePage();
        });
    </script>
</body>
</html>