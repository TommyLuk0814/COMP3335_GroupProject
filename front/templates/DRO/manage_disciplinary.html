<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DRO - Manage Disciplinary Records</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { color: #333; }
        h2 { color: #555; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        form { background: #fdfdfd; border: 1px solid #ccc; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        div { margin-bottom: 10px; }
        label { display: inline-block; width: 100px; }
        input[type="text"], input[type="date"], select, textarea { padding: 5px; width: 250px; }
        textarea { height: 60px; }
        button { padding: 5px 10px; background-color: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; }
        button:hover { background-color: #0056b3; }
        button.edit-btn { background-color: #ffc107; }
        button.edit-btn:hover { background-color: #e0a800; }
        button.delete-btn { background-color: #dc3545; }
        button.delete-btn:hover { background-color: #c82333; }
        button.clear-btn { background-color: #6c757d; }
        button.clear-btn:hover { background-color: #5a6268; }
        #logoutButton { background-color: #d9534f; float: right; }
        #logoutButton:hover { background-color: #c9302c; }
    </style>
</head>
<body>

    <button id="logoutButton">Logout</button>
    <h1>DRO Disciplinary Management</h1>

    <h2>Add / Edit Record</h2>
    <form id="recordForm">
        <input type="hidden" id="disciplinaryId" name="disciplinaryId">

        <div>
            <label for="studentId">Student:</label>
            <select id="studentId" name="studentId" required>
                <option value="">Loading students...</option>
            </select>
        </div>
        <input type="hidden" id="staffId" name="staffId">
        <div>
            <label for="date">Date:</label>
            <input type="date" id="date" name="date" required>
        </div>
        <div>
            <label for="descriptions">Descriptions:</label>
            <textarea id="descriptions" name="descriptions" required></textarea>
        </div>
        <button type="submit">Save Record</button>
        <button type="button" class="clear-btn" id="clearBtn">Clear Form</button>
    </form>

    <h2>Records List</h2>
    <div>
        <label for="filterStudent">Filter by Student:</label>
        <select id="filterStudent">
            <option value="">All Students</option>
        </select>
        <button id="filterBtn">Search</button>
        <button id="showAllBtn">Show All</button>
    </div>

    <table id="recordsTable">
        <thead>
            <tr>
                <th>Student</th>
                <th>Date</th>
                <th>Responsible Staff</th>
                <th>Descriptions</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="recordsTbody">
            </tbody>
    </table>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const token = localStorage.getItem('access_token');
            const userName = localStorage.getItem('name');
            const currentStaffId = localStorage.getItem('user_id');

            if (!token) {
                alert('You are not logged in. Redirecting to login page.');
                window.location.href = '/';
                return;
            }


            const recordForm = document.getElementById('recordForm');
            const disciplinaryIdInput = document.getElementById('disciplinaryId');
            const studentSelect = document.getElementById('studentId');
            const staffSelect = document.getElementById('staffId');
            const dateInput = document.getElementById('date');
            const descriptionsInput = document.getElementById('descriptions');

            const filterStudentSelect = document.getElementById('filterStudent');
            const filterBtn = document.getElementById('filterBtn');
            const showAllBtn = document.getElementById('showAllBtn');
            const clearBtn = document.getElementById('clearBtn');
            const logoutButton = document.getElementById('logoutButton');

            const recordsTbody = document.getElementById('recordsTbody');


            async function apiFetch(url, options = {}) {
                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                };
                const config = { ...options, headers: { ...headers, ...options.headers } };

                try {
                    const response = await fetch(url, config);
                    if (response.status === 401) {
                        alert('Session expired. Please log in again.');
                        logout();
                        return;
                    }
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'API request failed');
                    }
                    if (response.status === 204 || options.method === 'DELETE') {
                        return { success: true };
                    }
                    return response.json();
                } catch (error) {
                    console.error('Fetch error:', error);
                    alert(`Error: ${error.message}`);
                    throw error;
                }
            }

            // --- Load initial data ---


            async function loadStudents() {
                try {
                    const students = await apiFetch('/list_student');
                    studentSelect.innerHTML = '<option value="">Select Student</option>';
                    filterStudentSelect.innerHTML = '<option value="">All Students</option>';

                    students.forEach(student => {
                        const option = document.createElement('option');
                        option.value = student[0]; // id
                        option.textContent = `${student[1]} ${student[2]}`; // first_name last_name
                        studentSelect.appendChild(option.cloneNode(true));
                        filterStudentSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error('Failed to load students', error);
                }
            }






            async function loadRecords(studentId = null) {
                let url = '/list_disciplinary';
                if (studentId) {
                    url = `/list_disciplinary?student_id=${studentId}`;
                }

                try {
                    const records = await apiFetch(url);
                    renderRecordsTable(records);
                } catch (error) {
                    recordsTbody.innerHTML = '<tr><td colspan="5">Failed to load records.</td></tr>';
                    console.error('Failed to load records', error);
                }
            }

            // Rendering Discipline Record Table
            function renderRecordsTable(records) {
                recordsTbody.innerHTML = '';       //clear from
                if (!records || records.length === 0) {
                    recordsTbody.innerHTML = '<tr><td colspan="5">No records found.</td></tr>';
                    return;
                }



                records.forEach(record => {
                    const tr = document.createElement('tr');

                    const recordId = record[0];
                    const studentId = record[1];
                    const studentName = `${record[2]} ${record[3]}`;
                    const date = new Date(record[4]).toLocaleDateString(); // 格式化日期
                    const staffName = `${record[5]} ${record[6]}`;
                    const descriptions = record[7];



                    tr.innerHTML = `
                        <td>${studentName}</td>
                        <td>${date}</td>
                        <td>${staffName}</td>
                        <td>${descriptions}</td>
                        <td>
                            <button class="edit-btn"
                                    data-id="${recordId}"
                                    data-student-id="${studentId}"
                                    data-staff-id=""
                                    data-date="${record[4]}"
                                    data-descriptions="${descriptions}">Edit</button>
                            <button class="delete-btn" data-id="${recordId}">Delete</button>
                        </td>
                    `;


                    recordsTbody.appendChild(tr);
                });
            }



            logoutButton.addEventListener('click', logout);

            async function logout() {
                try {

                    await apiFetch('/logout', {
                        method: 'POST'
                    });

                } catch (error) {
                    // Even if the backend call fails, we still continue to clear the data on the frontend
                    console.error('Logout API call failed, proceeding with client-side logout:', error);
                }


                localStorage.removeItem('access_token');
                localStorage.removeItem('role');
                localStorage.removeItem('user_id');
                localStorage.removeItem('name');


                window.location.href = '/';
            }

            clearBtn.addEventListener('click', resetForm);

            filterBtn.addEventListener('click', () => {
                const selectedStudentId = filterStudentSelect.value;
                loadRecords(selectedStudentId);
            });

            showAllBtn.addEventListener('click', () => {
                filterStudentSelect.value = '';
                loadRecords();
            });

            // submit from
            recordForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const id = disciplinaryIdInput.value;
                const data = {
                    student_id: studentSelect.value,
                    staff_id: currentStaffId,
                    date: dateInput.value,
                    descriptions: descriptionsInput.value
                };

                try {
                    if (id) {

                        const updateData = {
                            disciplinary_id: id,
                            staff_id: currentStaffId,
                            descriptions: data.descriptions
                        };
                        await apiFetch('/modify_disciplinary', {
                            method: 'PUT',
                            body: JSON.stringify(updateData)
                        });
                        alert('Record updated successfully!');
                    } else {


                        await apiFetch('/add_disciplinary', {
                            method: 'POST',
                            body: JSON.stringify(data)
                        });
                        alert('Record added successfully!');
                    }

                    resetForm();
                    loadRecords(filterStudentSelect.value);

                } catch (error) {
                    alert('Failed to save record. ' + error.message);
                }
            });

            recordsTbody.addEventListener('click', async (e) => {
                const target = e.target;
                const id = target.dataset.id;

                if (target.classList.contains('edit-btn')) {
                    const { studentId, staffId, date, descriptions } = target.dataset;


                    disciplinaryIdInput.value = id;
                    studentSelect.value = studentId;

                    dateInput.value = date.split('T')[0];
                    descriptionsInput.value = descriptions;


                    studentSelect.disabled = true;

                    dateInput.disabled = true;

                    alert('Record loaded to Add/Edit form.\n\nStudent, Staff, and Date are locked.\nOnly Descriptions can be modified.');
                    window.scrollTo(0, 0);
                }

                //delete button
                if (target.classList.contains('delete-btn')) {

                    if (confirm(`Are you sure you want to delete record ${id}?`)) {
                        try {

                            await apiFetch(`/delete_disciplinary?disciplinary_id=${id}`, {
                                method: 'DELETE'
                            });
                            alert('Record deleted successfully!');
                            loadRecords(filterStudentSelect.value);
                        } catch (error) {
                            alert('Failed to delete record. ' + error.message);
                        }
                    }
                }
            });

            // reset form
            function resetForm() {
                recordForm.reset();
                disciplinaryIdInput.value = '';
                studentSelect.disabled = false;

                dateInput.disabled = false;

                const formTitle = document.querySelector('h2');
                formTitle.textContent = 'Add / Edit Record';
                formTitle.style.color = '#555';
            }

            // --- init print user name on the top--
            function initializePage() {
                if (userName) {
                    const welcome = document.createElement('h2');
                    welcome.textContent = `Welcome, ${userName} (DRO)`;
                    document.body.prepend(welcome);
                }
                loadStudents();
                loadRecords();
            }

            initializePage();
        });
    </script>
</body>
</html>