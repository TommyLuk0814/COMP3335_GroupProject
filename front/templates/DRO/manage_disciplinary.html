<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DRO - Manage Disciplinary Records</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { color: #333; }
        h2 { color: #555; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        form { background: #fdfdfd; border: 1px solid #ccc; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        div { margin-bottom: 10px; }
        label { display: inline-block; width: 100px; }
        input[type="text"], input[type="date"], select, textarea { padding: 5px; width: 250px; }
        textarea { height: 60px; }
        button { padding: 5px 10px; background-color: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; }
        button:hover { background-color: #0056b3; }
        button.edit-btn { background-color: #ffc107; }
        button.edit-btn:hover { background-color: #e0a800; }
        button.delete-btn { background-color: #dc3545; }
        button.delete-btn:hover { background-color: #c82333; }
        button.clear-btn { background-color: #6c757d; }
        button.clear-btn:hover { background-color: #5a6268; }
        #logoutButton { background-color: #d9534f; float: right; }
        #logoutButton:hover { background-color: #c9302c; }
    </style>
</head>
<body>

    <button id="logoutButton">Logout</button>
    <h1>DRO Disciplinary Management</h1>

    <h2>Add / Edit Record</h2>
    <form id="recordForm">
        <input type="hidden" id="disciplinaryId" name="disciplinaryId">

        <div>
            <label for="studentId">Student:</label>
            <select id="studentId" name="studentId" required>
                <option value="">Loading students...</option>
            </select>
        </div>
        <div>
            <label for="staffId">Staff:</label>
            <select id="staffId" name="staffId" required>
                <option value="">Loading staff...</option>
            </select>
        </div>
        <div>
            <label for="date">Date:</label>
            <input type="date" id="date" name="date" required>
        </div>
        <div>
            <label for="descriptions">Descriptions:</label>
            <textarea id="descriptions" name="descriptions" required></textarea>
        </div>
        <button type="submit">Save Record</button>
        <button type="button" class="clear-btn" id="clearBtn">Clear Form</button>
    </form>

    <h2>Records List</h2>
    <div>
        <label for="filterStudent">Filter by Student:</label>
        <select id="filterStudent">
            <option value="">All Students</option>
        </select>
        <button id="filterBtn">Filter</button>
        <button id="showAllBtn">Show All</button>
    </div>

    <table id="recordsTable">
        <thead>
            <tr>
                <th>Student</th>
                <th>Date</th>
                <th>Responsible Staff</th>
                <th>Descriptions</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="recordsTbody">
            </tbody>
    </table>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const token = localStorage.getItem('access_token');
            const userName = localStorage.getItem('name');

            if (!token) {
                alert('You are not logged in. Redirecting to login page.');
                window.location.href = '/';
                return;
            }

            // --- DOM 元素 ---
            const recordForm = document.getElementById('recordForm');
            const disciplinaryIdInput = document.getElementById('disciplinaryId');
            const studentSelect = document.getElementById('studentId');
            const staffSelect = document.getElementById('staffId');
            const dateInput = document.getElementById('date');
            const descriptionsInput = document.getElementById('descriptions');

            const filterStudentSelect = document.getElementById('filterStudent');
            const filterBtn = document.getElementById('filterBtn');
            const showAllBtn = document.getElementById('showAllBtn');
            const clearBtn = document.getElementById('clearBtn');
            const logoutButton = document.getElementById('logoutButton');

            const recordsTbody = document.getElementById('recordsTbody');

            // --- API 呼叫的通用函式 ---
            async function apiFetch(url, options = {}) {
                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                };
                const config = { ...options, headers: { ...headers, ...options.headers } };

                try {
                    const response = await fetch(url, config);
                    if (response.status === 401) {
                        alert('Session expired. Please log in again.');
                        logout();
                        return;
                    }
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'API request failed');
                    }
                    if (response.status === 204 || options.method === 'DELETE') {
                        return { success: true };
                    }
                    return response.json();
                } catch (error) {
                    console.error('Fetch error:', error);
                    alert(`Error: ${error.message}`);
                    throw error;
                }
            }

            // --- 載入初始數據 ---

            // 載入學生列表
            async function loadStudents() {
                try {
                    const students = await apiFetch('/list_student'); // 呼叫 API
                    studentSelect.innerHTML = '<option value="">Select Student</option>';
                    filterStudentSelect.innerHTML = '<option value="">All Students</option>';

                    students.forEach(student => {
                        const option = document.createElement('option');
                        option.value = student[0]; // id
                        option.textContent = `${student[1]} ${student[2]}`; // first_name last_name
                        studentSelect.appendChild(option.cloneNode(true));
                        filterStudentSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error('Failed to load students', error);
                }
            }

            // 載入教職員列表
            async function loadStaff() {
                try {
                    const staff = await apiFetch('/list_staff'); // 呼叫 API
                    staffSelect.innerHTML = '<option value="">Select Staff</option>';

                    staff.forEach(person => {
                        const option = document.createElement('option');
                        option.value = person[0]; // id
                        option.textContent = `${person[1]} ${person[2]}`; // first_name last_name
                        staffSelect.appendChild(option);
                    });
                } catch (error)
 {
                    console.error('Failed to load staff', error);
                }
            }

            // --- 載入紀律記錄 ---

            // 載入紀律記錄 (可選 student_id 過濾)
            async function loadRecords(studentId = null) {
                let url = '/list_disciplinary';
                if (studentId) {
                    url = `/list_disciplinary?student_id=${studentId}`;
                }

                try {
                    const records = await apiFetch(url);
                    renderRecordsTable(records);
                } catch (error) {
                    recordsTbody.innerHTML = '<tr><td colspan="5">Failed to load records.</td></tr>';
                    console.error('Failed to load records', error);
                }
            }

            // 渲染紀律記錄表格
            function renderRecordsTable(records) {
                recordsTbody.innerHTML = ''; // 清空表格
                if (!records || records.length === 0) {
                    recordsTbody.innerHTML = '<tr><td colspan="5">No records found.</td></tr>';
                    return;
                }

                // 根據 sql_method_ARO_DRO.py 中的 list_all_disciplinary_sql()
                // 回傳順序: d.id[0], d.student_id[1], s.first_name[2], s.last_name[3],
                //            d.date[4], st.first_name[5], st.last_name[6], d.descriptions[7],
                //            d.staff_id[?] (我們需要 staff_id 才能編輯)

                // *** 假設您修改 SQL 查詢，在最後加入 d.staff_id AS staff_id ***
                // 假設 d.staff_id 是索引 [8]

                // *** 暫時使用您 *目前* 的 SQL 輸出 ***
                // 我們將無法在 "Edit" 時預選 Staff
                // 我們需要 d.staff_id
                // *** 假設您已修改 SQL，d.staff_id 在索引 [8] ***

                records.forEach(record => {
                    const tr = document.createElement('tr');

                    const recordId = record[0];
                    const studentId = record[1];
                    const studentName = `${record[2]} ${record[3]}`;
                    const date = new Date(record[4]).toLocaleDateString(); // 格式化日期
                    const staffName = `${record[5]} ${record[6]}`;
                    const descriptions = record[7];

                    // 假設 SQL 查詢已修改為 SELECT ..., d.staff_id (在索引 8)
                    // const staffId = record[8];
                    // 如果 SQL 沒修改，我們只能在 data- 屬性中留空

                    tr.innerHTML = `
                        <td>${studentName}</td>
                        <td>${date}</td>
                        <td>${staffName}</td>
                        <td>${descriptions}</td>
                        <td>
                            <button class="edit-btn"
                                    data-id="${recordId}"
                                    data-student-id="${studentId}"
                                    data-staff-id=""
                                    data-date="${record[4]}"
                                    data-descriptions="${descriptions}">Edit</button>
                            <button class="delete-btn" data-id="${recordId}">Delete</button>
                        </td>
                    `;
                    // 注意: 為了讓 "Edit" 正常運作，
                    // 您的 `list_all_disciplinary_sql` 和 `list_disciplinary_by_student_id`
                    // 必須 SELECT ... d.staff_id
                    // 假設修改後 d.staff_id 在索引 [8]
                    // const editBtn = tr.querySelector('.edit-btn');
                    // editBtn.dataset.staffId = record[8];

                    recordsTbody.appendChild(tr);
                });
            }

            // --- 事件監聽 ---

            logoutButton.addEventListener('click', logout);

            function logout() {
                localStorage.removeItem('access_token');
                localStorage.removeItem('role');
                localStorage.removeItem('user_id');
                localStorage.removeItem('name');
                window.location.href = '/';
            }

            clearBtn.addEventListener('click', resetForm);

            filterBtn.addEventListener('click', () => {
                const selectedStudentId = filterStudentSelect.value;
                loadRecords(selectedStudentId);
            });

            showAllBtn.addEventListener('click', () => {
                filterStudentSelect.value = '';
                loadRecords();
            });

            // 提交表單 (新增或更新)
            recordForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const id = disciplinaryIdInput.value;
                const data = {
                    student_id: studentSelect.value,
                    staff_id: staffSelect.value,
                    date: dateInput.value,
                    descriptions: descriptionsInput.value
                };

                try {
                    if (id) {
                        // 更新 (PUT)
                        // 根據 server.py，/modify_disciplinary 需要 disciplinary_id, descriptions
                        const updateData = {
                            disciplinary_id: id,
                            descriptions: data.descriptions
                        };
                        await apiFetch('/modify_disciplinary', {
                            method: 'PUT',
                            body: JSON.stringify(updateData)
                        });
                        alert('Record updated successfully!');
                    } else {
                        // 新增 (POST)
                        // 根據 server.py，/add_disciplinary 需要 student_id, staff_id, date, descriptions
                        await apiFetch('/add_disciplinary', {
                            method: 'POST',
                            body: JSON.stringify(data)
                        });
                        alert('Record added successfully!');
                    }

                    resetForm();
                    loadRecords(filterStudentSelect.value); // 重新載入表格

                } catch (error) {
                    alert('Failed to save record. ' + error.message);
                }
            });

            // 表格點擊 (處理編輯和刪除)
            recordsTbody.addEventListener('click', async (e) => {
                const target = e.target;
                const id = target.dataset.id;

                if (target.classList.contains('edit-btn')) {
                    // 編輯按鈕
                    const { studentId, staffId, date, descriptions } = target.dataset;

                    // 填入表單
                    disciplinaryIdInput.value = id;
                    studentSelect.value = studentId;
                    staffSelect.value = staffId; // (如果 data-staff-id 有值)
                    dateInput.value = date.split('T')[0]; // 處理日期格式
                    descriptionsInput.value = descriptions;

                    // 根據 SQL 邏輯，只允許修改 descriptions
                    studentSelect.disabled = true;
                    staffSelect.disabled = true;
                    dateInput.disabled = true;

                    alert('Editing Record. Student, Staff, and Date are locked. Only Descriptions can be modified.');
                    window.scrollTo(0, 0); // 滾動到頁面頂部
                }

                if (target.classList.contains('delete-btn')) {
                    // 刪除按鈕
                    if (confirm(`Are you sure you want to delete record ${id}?`)) {
                        try {
                            // 根據 server.py，使用 URL 參數
                            await apiFetch(`/delete_disciplinary?disciplinary_id=${id}`, {
                                method: 'DELETE'
                            });
                            alert('Record deleted successfully!');
                            loadRecords(filterStudentSelect.value); // 重新載入表格
                        } catch (error) {
                            alert('Failed to delete record. ' + error.message);
                        }
                    }
                }
            });

            // 重設表單
            function resetForm() {
                recordForm.reset();
                disciplinaryIdInput.value = '';
                // 重新啟用下拉選單
                studentSelect.disabled = false;
                staffSelect.disabled = false;
                dateInput.disabled = false;
            }

            // --- 初始化頁面 ---
            function initializePage() {
                if (userName) {
                    const welcome = document.createElement('h2');
                    welcome.textContent = `Welcome, ${userName} (DRO)`;
                    document.body.prepend(welcome);
                }
                loadStudents();
                loadStaff();
                loadRecords(); // 初始載入所有記錄
            }

            initializePage();
        });
    </script>
</body>
</html>